<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜• Analytics Dashboard - Coffee Shop Admin</title>
    <link rel="stylesheet" href="/css/themes.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/components.css">
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-bg, #fff);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .period-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color, #ddd);
            background: var(--surface-color, #f8f9fa);
            color: var(--text-color, #333);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-btn.active,
        .period-btn:hover {
            background: var(--primary-color, #8B4513);
            color: white;
            border-color: var(--primary-color, #8B4513);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg, #fff);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color, #8B4513);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .metric-title {
            font-size: 14px;
            color: var(--text-secondary, #666);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-color, #333);
            margin-bottom: 10px;
        }

        .metric-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-change.positive {
            color: var(--success-color, #28a745);
        }

        .metric-change.negative {
            color: var(--error-color, #dc3545);
        }

        .metric-change.neutral {
            color: var(--text-secondary, #666);
        }

        .chart-container {
            background: var(--card-bg, #fff);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color, #ddd);
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color, #333);
        }

        .chart-subtitle {
            font-size: 14px;
            color: var(--text-secondary, #666);
        }

        .chart-placeholder {
            height: 300px;
            background: var(--surface-color, #f8f9fa);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary, #666);
            font-style: italic;
        }

        .top-items-list {
            list-style: none;
            padding: 0;
        }

        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color, #ddd);
        }

        .top-item:last-child {
            border-bottom: none;
        }

        .item-info {
            display: flex;
            flex-direction: column;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-color, #333);
        }

        .item-details {
            font-size: 12px;
            color: var(--text-secondary, #666);
        }

        .item-value {
            font-weight: bold;
            color: var(--primary-color, #8B4513);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .category-card {
            background: var(--surface-color, #f8f9fa);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color, #ddd);
        }

        .category-name {
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: capitalize;
            color: var(--text-color, #333);
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary, #666);
        }

        .system-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--surface-color, #f8f9fa);
            border-radius: 5px;
            border-left: 3px solid var(--success-color, #28a745);
        }

        .status-item.warning {
            border-left-color: var(--warning-color, #ffc107);
        }

        .status-item.error {
            border-left-color: var(--error-color, #dc3545);
        }

        .status-label {
            font-weight: 600;
            color: var(--text-color, #333);
        }

        .status-value {
            color: var(--text-secondary, #666);
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary, #666);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .refresh-btn {
            background: var(--primary-color, #8B4513);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background: var(--primary-dark, #654321);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .analytics-header {
                flex-direction: column;
                gap: 20px;
            }

            .period-selector {
                flex-wrap: wrap;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="/pages/store.html">â˜• Coffee Shop</a>
            </div>
            <div class="nav-menu">
                <a href="/pages/admin.html">Admin Panel</a>
                <a href="/pages/admin-analytics.html" class="active">Analytics</a>
                <a href="/pages/store.html">Store</a>
                <div id="auth-section">
                    <a href="#" onclick="window.authManager.logout()">Logout</a>
                </div>
            </div>
        </nav>

        <main class="analytics-container">
            <div id="access-denied" class="error-message" style="display: none;">
                <h2>Access Denied</h2>
                <p>You need admin privileges to view analytics. <a href="/pages/login.html">Login as admin</a></p>
            </div>

            <div id="analytics-content" style="display: none;">
                <div class="analytics-header">
                    <div>
                        <h1>Analytics Dashboard</h1>
                        <p>Comprehensive insights into your coffee shop's performance</p>
                    </div>
                    <div class="analytics-controls">
                        <div class="period-selector">
                            <span>Period:</span>
                            <button class="period-btn active" data-period="7d">7 Days</button>
                            <button class="period-btn" data-period="30d">30 Days</button>
                            <button class="period-btn" data-period="90d">90 Days</button>
                            <button class="period-btn" data-period="1y">1 Year</button>
                        </div>
                        <button id="refresh-btn" class="refresh-btn">
                            <span>ðŸ”„</span>
                            Refresh
                        </button>
                    </div>
                </div>

                <div id="loading" class="loading">
                    Loading analytics data...
                </div>

                <div id="error-message" class="error-message" style="display: none;"></div>

                <!-- Key Metrics -->
                <div id="metrics-grid" class="dashboard-grid" style="display: none;">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Total Revenue</span>
                            <span class="metric-icon">ðŸ’°</span>
                        </div>
                        <div class="metric-value" id="total-revenue">$0.00</div>
                        <div class="metric-change" id="revenue-change">
                            <span>ðŸ“ˆ</span>
                            <span>+0% from previous period</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Total Orders</span>
                            <span class="metric-icon">ðŸ“¦</span>
                        </div>
                        <div class="metric-value" id="total-orders">0</div>
                        <div class="metric-change" id="orders-change">
                            <span>ðŸ“ˆ</span>
                            <span>+0% from previous period</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Average Order</span>
                            <span class="metric-icon">ðŸ›’</span>
                        </div>
                        <div class="metric-value" id="avg-order-value">$0.00</div>
                        <div class="metric-change" id="aov-change">
                            <span>ðŸ“Š</span>
                            <span>+0% from previous period</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Active Users</span>
                            <span class="metric-icon">ðŸ‘¥</span>
                        </div>
                        <div class="metric-value" id="active-users">0</div>
                        <div class="metric-change" id="users-change">
                            <span>ðŸ‘¤</span>
                            <span>0% of total users</span>
                        </div>
                    </div>
                </div>

                <!-- Sales Chart -->
                <div id="sales-chart" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Sales Trends</div>
                            <div class="chart-subtitle">Revenue and orders over time</div>
                        </div>
                    </div>
                    <div class="chart-placeholder">
                        Sales chart visualization would appear here
                        <br><small>(Chart.js or similar library would be integrated)</small>
                    </div>
                </div>

                <!-- Top Products -->
                <div id="top-products" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <div class="chart-title">Top Products</div>
                    </div>
                    <ul id="top-products-list" class="top-items-list">
                        <!-- Top products will be inserted here -->
                    </ul>
                </div>

                <!-- Category Performance -->
                <div id="category-performance" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <div class="chart-title">Category Performance</div>
                    </div>
                    <div id="category-grid" class="category-grid">
                        <!-- Category cards will be inserted here -->
                    </div>
                </div>

                <!-- Top Customers -->
                <div id="top-customers" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <div class="chart-title">Top Customers</div>
                    </div>
                    <ul id="top-customers-list" class="top-items-list">
                        <!-- Top customers will be inserted here -->
                    </ul>
                </div>

                <!-- System Health -->
                <div id="system-health" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <div class="chart-title">System Health</div>
                        <div class="chart-subtitle">Server performance and data integrity</div>
                    </div>
                    <div id="system-status" class="system-status">
                        <!-- System status items will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/theme.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        class AnalyticsManager {
            constructor() {
                this.currentPeriod = '7d';
                this.data = {};
                this.isLoading = false;
            }

            async init() {
                const user = window.authManager.currentUser;
                
                if (!user || user.role !== 'admin') {
                    document.getElementById('access-denied').style.display = 'block';
                    return;
                }

                document.getElementById('analytics-content').style.display = 'block';
                this.setupEventListeners();
                await this.loadAllAnalytics();
            }

            setupEventListeners() {
                // Period selector buttons
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentPeriod = e.target.dataset.period;
                        this.loadAllAnalytics();
                    });
                });

                // Refresh button
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.loadAllAnalytics();
                });
            }

            async loadAllAnalytics() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showLoading(true);
                this.showError(false);

                try {
                    // Load all analytics data in parallel
                    const [salesData, userData, productData, systemData] = await Promise.all([
                        window.authManager.apiClient.get(`/analytics/sales?period=${this.currentPeriod}`),
                        window.authManager.apiClient.get('/analytics/users'),
                        window.authManager.apiClient.get('/analytics/products'),
                        window.authManager.apiClient.get('/analytics/system')
                    ]);

                    if (salesData.success) this.data.sales = salesData.data;
                    if (userData.success) this.data.users = userData.data;
                    if (productData.success) this.data.products = productData.data;
                    if (systemData.success) this.data.system = systemData.data;

                    this.updateDashboard();
                    this.showContent(true);
                } catch (error) {
                    console.error('Failed to load analytics:', error);
                    this.showError(true, 'Failed to load analytics data');
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                }
            }

            updateDashboard() {
                if (this.data.sales) this.updateSalesMetrics();
                if (this.data.users) this.updateUserMetrics();
                if (this.data.products) this.updateProductMetrics();
                if (this.data.system) this.updateSystemHealth();
            }

            updateSalesMetrics() {
                const sales = this.data.sales;
                
                document.getElementById('total-revenue').textContent = `$${sales.totals.revenue.toFixed(2)}`;
                document.getElementById('total-orders').textContent = sales.totals.orders.toLocaleString();
                document.getElementById('avg-order-value').textContent = `$${sales.totals.averageOrderValue.toFixed(2)}`;

                // Update change indicators
                this.updateChangeIndicator('revenue-change', sales.totals.revenueGrowth, '%');
                this.updateChangeIndicator('orders-change', sales.trends.ordersGrowth, '%');
                this.updateChangeIndicator('aov-change', sales.trends.averageOrderValueGrowth, '%');
            }

            updateUserMetrics() {
                const users = this.data.users;
                
                document.getElementById('active-users').textContent = users.totals.activeUsers.toLocaleString();
                
                const activePercentage = users.totals.activeUsersPercentage;
                const usersChangeEl = document.getElementById('users-change');
                usersChangeEl.querySelector('span:last-child').textContent = `${activePercentage.toFixed(1)}% of total users`;
                
                // Update top customers
                this.updateTopCustomers(users.topCustomers);
            }

            updateProductMetrics() {
                const products = this.data.products;
                
                // Update top products
                this.updateTopProducts(products.topPerformers.topRevenue);
                
                // Update category performance
                this.updateCategoryPerformance(products.categoryPerformance);
            }

            updateSystemHealth() {
                const system = this.data.system;
                const statusContainer = document.getElementById('system-status');
                
                const statusItems = [
                    { label: 'Server Status', value: system.system.status, type: 'success' },
                    { label: 'Uptime', value: `${Math.floor(system.system.uptime / 3600)}h ${Math.floor((system.system.uptime % 3600) / 60)}m`, type: 'success' },
                    { label: 'Response Time', value: `${system.system.responseTime}ms`, type: system.system.responseTime < 100 ? 'success' : 'warning' },
                    { label: 'Memory Usage', value: `${system.memory.used}MB`, type: system.memory.used < 500 ? 'success' : 'warning' },
                    { label: 'Database', value: system.healthChecks.database ? 'Healthy' : 'Error', type: system.healthChecks.database ? 'success' : 'error' }
                ];

                statusContainer.innerHTML = statusItems.map(item => `
                    <div class="status-item ${item.type}">
                        <span class="status-label">${item.label}</span>
                        <span class="status-value">${item.value}</span>
                    </div>
                `).join('');
            }

            updateTopProducts(topProducts) {
                const list = document.getElementById('top-products-list');
                
                list.innerHTML = topProducts.slice(0, 10).map((product, index) => `
                    <li class="top-item">
                        <div class="item-info">
                            <div class="item-name">#${index + 1} ${product.title}</div>
                            <div class="item-details">Sold: ${product.totalSold} units</div>
                        </div>
                        <div class="item-value">$${product.revenue.toFixed(2)}</div>
                    </li>
                `).join('');
            }

            updateTopCustomers(topCustomers) {
                const list = document.getElementById('top-customers-list');
                
                list.innerHTML = topCustomers.slice(0, 10).map((customer, index) => `
                    <li class="top-item">
                        <div class="item-info">
                            <div class="item-name">#${index + 1} ${customer.username}</div>
                            <div class="item-details">${customer.totalOrders} orders</div>
                        </div>
                        <div class="item-value">$${customer.totalSpent.toFixed(2)}</div>
                    </li>
                `).join('');
            }

            updateCategoryPerformance(categories) {
                const grid = document.getElementById('category-grid');
                
                grid.innerHTML = categories.map(category => `
                    <div class="category-card">
                        <div class="category-name">${category.category}</div>
                        <div class="category-stats">
                            <span>Products: ${category.productCount}</span>
                            <span>Revenue: $${category.revenue.toFixed(0)}</span>
                        </div>
                    </div>
                `).join('');
            }

            updateChangeIndicator(elementId, value, suffix = '') {
                const element = document.getElementById(elementId);
                const span = element.querySelector('span:last-child');
                const icon = element.querySelector('span:first-child');
                
                if (value > 0) {
                    element.className = 'metric-change positive';
                    icon.textContent = 'ðŸ“ˆ';
                    span.textContent = `+${value.toFixed(1)}${suffix} from previous period`;
                } else if (value < 0) {
                    element.className = 'metric-change negative';
                    icon.textContent = 'ðŸ“‰';
                    span.textContent = `${value.toFixed(1)}${suffix} from previous period`;
                } else {
                    element.className = 'metric-change neutral';
                    icon.textContent = 'ðŸ“Š';
                    span.textContent = `No change from previous period`;
                }
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
                document.getElementById('refresh-btn').disabled = show;
            }

            showError(show, message = '') {
                const errorEl = document.getElementById('error-message');
                if (show) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                } else {
                    errorEl.style.display = 'none';
                }
            }

            showContent(show) {
                const sections = [
                    'metrics-grid',
                    'sales-chart', 
                    'top-products',
                    'category-performance',
                    'top-customers',
                    'system-health'
                ];
                
                sections.forEach(id => {
                    document.getElementById(id).style.display = show ? 'block' : 'none';
                });
            }
        }

        // Global instance
        const analyticsManager = new AnalyticsManager();

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait for authManager to be ready
                while (!window.authManager) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                await analyticsManager.init();
            } catch (error) {
                console.error('Failed to initialize analytics dashboard:', error);
            }
        });
    </script>
</body>
</html>