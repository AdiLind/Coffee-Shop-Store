<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚òï Coffee Shop - Admin Dashboard</title>
    <link rel="stylesheet" href="/css/themes.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/components.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>‚òï Admin Dashboard</h1>
            <p>Manage your coffee shop</p>
            
            <nav class="navbar">
                <div class="container">
                    <div class="nav-brand">
                        <a href="/pages/store.html">‚òï Coffee Shop</a>
                    </div>
                    <div class="nav-menu">
                        <a href="/pages/admin.html" class="active">Admin Panel</a>
                        <a href="/pages/admin-analytics.html">Analytics</a>
                        <a href="/pages/store.html">Store</a>
                        <div id="auth-section">
                            <a href="#" onclick="window.authManager.logout()">Logout</a>
                        </div>
                    </div>
                    <div class="theme-toggle-container">
                        <button id="theme-toggle" class="theme-toggle" title="Change Theme">üé®</button>
                    </div>
                </div>
            </nav>
        </header>
        
        <main class="main">
            <!-- Login Required Message -->
            <div id="loginRequired" class="message" style="display: none; background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                <h2>üîê Admin Access Required</h2>
                <p>Please <a href="/pages/login.html" style="color: #721c24; font-weight: bold;">login as admin</a> to access the admin panel.</p>
                <p><strong>Admin credentials:</strong> username: <code>admin</code>, password: <code>admin</code></p>
            </div>

            <div class="admin-section">
                <div class="admin-stats">
                    <h2>Store Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Products</h3>
                            <p class="stat-number" id="totalProducts">Loading...</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Users</h3>
                            <p class="stat-number" id="totalUsers">Loading...</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Orders</h3>
                            <p class="stat-number" id="totalOrders">Loading...</p>
                        </div>
                        <div class="stat-card">
                            <h3>Revenue</h3>
                            <p class="stat-number" id="totalRevenue">Loading...</p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-actions">
                    <h2>Admin Actions</h2>
                    <div class="actions-grid">
                        <button class="btn btn-primary admin-btn" data-action="products">Manage Products</button>
                        <button class="btn btn-primary admin-btn" data-action="users">View Users</button>
                        <button class="btn btn-primary admin-btn" data-action="orders">View Orders</button>
                        <button class="btn btn-primary admin-btn" data-action="activity">View Activity</button>
                    </div>
                </div>
                
                <div class="admin-forms">
                    <h2>Add New Product</h2>
                    <form id="addProductForm" class="admin-form">
                        <div class="form-group">
                            <label for="productTitle">Product Title</label>
                            <input type="text" id="productTitle" name="title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Description</label>
                            <textarea id="productDescription" name="description" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="productPrice">Price ($)</label>
                            <input type="number" id="productPrice" name="price" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productCategory">Category</label>
                            <select id="productCategory" name="category" required>
                                <option value="">Select Category</option>
                                <option value="machines">Machines</option>
                                <option value="beans">Coffee Beans</option>
                                <option value="accessories">Accessories</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Add Product</button>
                    </form>
                </div>
                
                <div id="adminMessage" class="message hidden"></div>
            </div>
        </main>
        
        <footer class="footer">
            <p>&copy; 2025 Coffee Shop. Premium coffee experience.</p>
        </footer>
    </div>
    
    <script src="/js/theme.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        class AdminManager {
            constructor() {
                this.currentUser = null;
            }

            async init() {
                try {
                    // Wait for authManager to check current authentication status
                    await window.authManager.checkAuthStatus();
                    this.currentUser = window.authManager.currentUser;
                    
                    if (!this.currentUser || this.currentUser.role !== 'admin') {
                        document.getElementById('loginRequired').style.display = 'block';
                        document.querySelector('.admin-section').style.display = 'none';
                        return;
                    }

                    this.setupEventListeners();
                    await this.loadAdminStats();
                } catch (error) {
                    console.error('Admin panel initialization failed:', error);
                    document.getElementById('loginRequired').style.display = 'block';
                    document.querySelector('.admin-section').style.display = 'none';
                }
            }

            setupEventListeners() {
                // Admin action buttons
                document.querySelectorAll('.admin-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.getAttribute('data-action');
                        this.handleAdminAction(action);
                    });
                });

                // Add product form
                const addProductForm = document.getElementById('addProductForm');
                if (addProductForm) {
                    addProductForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleAddProduct(e.target);
                    });
                }
            }

            async loadAdminStats() {
                try {
                    // Load products count
                    const productsRes = await window.authManager.apiClient.get('/products');
                    if (productsRes.success) {
                        document.getElementById('totalProducts').textContent = productsRes.data.length;
                    } else {
                        document.getElementById('totalProducts').textContent = 'Error';
                    }

                    // Load users count
                    const usersRes = await window.authManager.apiClient.get('/admin/users');
                    if (usersRes.success) {
                        document.getElementById('totalUsers').textContent = usersRes.data.length;
                    } else {
                        document.getElementById('totalUsers').textContent = 'Error';
                    }

                    // Load orders count and revenue
                    const ordersRes = await window.authManager.apiClient.get('/admin/orders');
                    if (ordersRes.success) {
                        const orders = ordersRes.data;
                        document.getElementById('totalOrders').textContent = orders.length;
                        const revenue = orders.reduce((sum, order) => sum + (order.totalAmount || order.total || 0), 0);
                        document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
                    } else {
                        document.getElementById('totalOrders').textContent = 'Error';
                        document.getElementById('totalRevenue').textContent = 'Error';
                    }
                } catch (error) {
                    console.error('Failed to load admin stats:', error);
                    document.getElementById('totalProducts').textContent = 'Error';
                    document.getElementById('totalUsers').textContent = 'Error';
                    document.getElementById('totalOrders').textContent = 'Error';
                    document.getElementById('totalRevenue').textContent = 'Error';
                }
            }


            handleAdminAction(action) {
                const messageDiv = document.getElementById('adminMessage');
                
                switch (action) {
                    case 'products':
                        this.showProductsManagement();
                        break;
                    case 'users':
                        this.showUsersManagement();
                        break;
                    case 'orders':
                        this.showOrdersManagement();
                        break;
                    case 'activity':
                        window.location.href = '/pages/admin-analytics.html';
                        break;
                    default:
                        this.showMessage('Unknown action', 'error');
                }
            }

            async showProductsManagement() {
                try {
                    const response = await window.authManager.apiClient.get('/products');
                    if (response.success) {
                        this.displayProductsTable(response.data);
                    }
                } catch (error) {
                    this.showMessage('Failed to load products', 'error');
                }
            }

            async showUsersManagement() {
                try {
                    const response = await window.authManager.apiClient.get('/admin/users');
                    if (response.success) {
                        this.displayUsersTable(response.data);
                    }
                } catch (error) {
                    this.showMessage('Failed to load users', 'error');
                }
            }

            async showOrdersManagement() {
                try {
                    const ordersRes = await window.authManager.apiClient.get('/admin/orders');
                    if (ordersRes.success) {
                        this.displayOrdersTable(ordersRes.data);
                    } else {
                        this.showMessage('Failed to load orders', 'error');
                    }
                } catch (error) {
                    this.showMessage('Failed to load orders', 'error');
                }
            }

            displayProductsTable(products) {
                const html = `
                    <div class="management-section">
                        <h3>Products Management</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => `
                                    <tr>
                                        <td>${product.id}</td>
                                        <td>${product.title}</td>
                                        <td>${product.category}</td>
                                        <td>${formatCurrency(product.price)}</td>
                                        <td>${product.inStock ? 'In Stock' : 'Out of Stock'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="window.AdminManager.deleteProduct('${product.id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="btn btn-secondary" onclick="window.AdminManager.hideManagement()">Close</button>
                    </div>
                `;
                this.showManagementSection(html);
            }

            displayUsersTable(users) {
                const html = `
                    <div class="management-section">
                        <h3>Users Management</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.id.substring(0, 8)}...</td>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td><span class="role-badge ${user.role}">${user.role}</span></td>
                                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                        <td>${new Date(user.lastLogin).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="btn btn-secondary" onclick="window.AdminManager.hideManagement()">Close</button>
                    </div>
                `;
                this.showManagementSection(html);
            }

            displayOrdersTable(orders) {
                const html = `
                    <div class="management-section">
                        <h3>Orders Management</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orders.map(order => `
                                    <tr>
                                        <td>${order.id.substring(0, 8)}...</td>
                                        <td>${order.customerInfo?.name || 'N/A'}</td>
                                        <td>${order.items?.length || 0} items</td>
                                        <td>${formatCurrency(order.totalAmount || order.total || 0)}</td>
                                        <td><span class="status-badge ${order.status}">${order.status}</span></td>
                                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="window.AdminManager.viewOrderDetails('${order.id}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="btn btn-secondary" onclick="window.AdminManager.hideManagement()">Close</button>
                    </div>
                `;
                this.showManagementSection(html);
            }

            showManagementSection(html) {
                let managementDiv = document.getElementById('managementSection');
                if (!managementDiv) {
                    managementDiv = document.createElement('div');
                    managementDiv.id = 'managementSection';
                    managementDiv.className = 'management-container';
                    document.querySelector('.admin-section').appendChild(managementDiv);
                }
                managementDiv.innerHTML = html;
                managementDiv.scrollIntoView({ behavior: 'smooth' });
            }

            hideManagement() {
                const managementDiv = document.getElementById('managementSection');
                if (managementDiv) {
                    managementDiv.innerHTML = '';
                }
            }

            async deleteProduct(productId) {
                if (!confirm('Are you sure you want to delete this product?')) {
                    return;
                }
                
                try {
                    const response = await window.authManager.apiClient.delete(`/products/${productId}`);
                    if (response.success) {
                        this.showMessage('Product deleted successfully', 'success');
                        await this.loadAdminStats();
                        this.showProductsManagement();
                    } else {
                        this.showMessage('Failed to delete product', 'error');
                    }
                } catch (error) {
                    this.showMessage('Failed to delete product', 'error');
                }
            }

            async viewOrderDetails(orderId) {
                try {
                    const ordersRes = await window.authManager.apiClient.get('/admin/orders');
                    if (ordersRes.success) {
                        const order = ordersRes.data.find(o => o.id === orderId);
                        if (order) {
                            this.displayOrderDetails(order);
                        } else {
                            this.showMessage('Order not found', 'error');
                        }
                    } else {
                        this.showMessage('Failed to load order details', 'error');
                    }
                } catch (error) {
                    this.showMessage('Failed to load order details', 'error');
                }
            }

            displayOrderDetails(order) {
                const html = `
                    <div class="order-details">
                        <h4>Order Details: ${order.id}</h4>
                        <div class="order-info">
                            <p><strong>Customer:</strong> ${order.customerInfo?.name || 'N/A'}</p>
                            <p><strong>Email:</strong> ${order.customerInfo?.email || 'N/A'}</p>
                            <p><strong>Address:</strong> ${order.shippingAddress || 'N/A'}</p>
                            <p><strong>Status:</strong> ${order.status}</p>
                            <p><strong>Total:</strong> ${formatCurrency(order.totalAmount || order.total || 0)}</p>
                            <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                        </div>
                        <h5>Items:</h5>
                        <ul class="order-items">
                            ${order.items?.map(item => `
                                <li>${item.title} - Qty: ${item.quantity} - ${formatCurrency((item.price || 0) * (item.quantity || 1))}</li>
                            `).join('') || '<li>No items</li>'}
                        </ul>
                        <button class="btn btn-secondary" onclick="window.AdminManager.hideManagement()">Close</button>
                    </div>
                `;
                this.showManagementSection(html);
            }

            async handleAddProduct(form) {
                const messageDiv = document.getElementById('adminMessage');
                const formData = new FormData(form);
                
                const product = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    category: formData.get('category')
                };

                try {
                    const response = await window.authManager.apiClient.post('/products', product);
                    
                    if (response.success) {
                        this.showMessage('Product added successfully!', 'success');
                        form.reset();
                        await this.loadAdminStats();
                    } else {
                        this.showMessage(response.message || 'Failed to add product', 'error');
                    }
                } catch (error) {
                    console.error('Add product error:', error);
                    this.showMessage('Failed to add product', 'error');
                }
            }

            showMessage(message, type) {
                const messageDiv = document.getElementById('adminMessage');
                if (messageDiv) {
                    messageDiv.innerHTML = `<p class="${type}">${message}</p>`;
                    messageDiv.classList.remove('hidden');
                }
            }
        }

        // Global AdminManager instance for onclick handlers
        window.AdminManager = null;

        // Initialize admin manager
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait for authManager to be ready
                while (!window.authManager) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                window.AdminManager = new AdminManager();
                await window.AdminManager.init();
            } catch (error) {
                console.error('Failed to initialize admin panel:', error);
            }
        });
    </script>
</body>
</html>